<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:Easy2Do.ViewModels"
        xmlns:conv="using:Easy2Do.Converters"
        mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="500"
        x:Class="Easy2Do.Views.NoteWindow"
        x:DataType="vm:NoteViewModel"
        Title="{Binding Note.Title}"
        Width="400" Height="500"
        MinWidth="300" MinHeight="400"
        Background="{Binding Note.Color}">

  <Window.Resources>
    <conv:BoolToBrushConverter x:Key="ImportantBrush" TrueBrush="#D32F2F" FalseBrush="#000000" />
    <conv:BoolToBrushConverter x:Key="ImportantCompletedBrush" TrueBrush="#D32F2F" FalseBrush="#FF888888" />
    <conv:BoolToBrushConverter x:Key="ImportantButtonBrush" TrueBrush="#D32F2F" FalseBrush="#888888" />
    <conv:BoolToBrushConverter x:Key="ImportantRowBrush" TrueBrush="#1AD32F2F" FalseBrush="Transparent" />
    <conv:BoolOrMultiConverter x:Key="BoolOrConverter" />
    <conv:BoolToFontWeightConverter x:Key="ImportantFontWeight" />
  </Window.Resources>

  <Design.DataContext>
    <vm:NoteViewModel />
  </Design.DataContext>

  <Grid RowDefinitions="Auto,Auto,*,Auto">
    <!-- Title Section -->
    <Border Grid.Row="0" 
            Background="#33000000" 
            Padding="15,10"
            CornerRadius="5,5,0,0"
            Margin="10,10,10,5">
      <Grid ColumnDefinitions="*,Auto">
        <TextBox Grid.Column="0"
                 x:Name="TitleTextBox"
                 Text="{Binding Note.Title, UpdateSourceTrigger=PropertyChanged}"
                 FontFamily="Segoe UI Emoji, Segoe UI Symbol, Segoe UI"
                 FontSize="20"
                 FontWeight="Normal"
                 BorderThickness="0"
                 Background="Transparent"
                 Watermark="Note Title..."
                 GotFocus="OnTitleTextBoxGotFocus"
                 PointerPressed="OnTitleTextBoxPointerPressed"
                 KeyDown="OnTitleTextBoxKeyDown"/>
        
        <!-- Color Picker Menu -->
        <DropDownButton Grid.Column="1"
                        Content="Color"
                        FontSize="14"
                        Padding="8">
          <DropDownButton.Flyout>
            <MenuFlyout Placement="Bottom">
              <MenuItem Header="Yellow" Command="{Binding ChangeColorCommand}" CommandParameter="#FFFFE680"/>
              <MenuItem Header="Red" Command="{Binding ChangeColorCommand}" CommandParameter="#FFFF9999"/>
              <MenuItem Header="Green" Command="{Binding ChangeColorCommand}" CommandParameter="#FF99FF99"/>
              <MenuItem Header="Blue" Command="{Binding ChangeColorCommand}" CommandParameter="#FF99CCFF"/>
              <MenuItem Header="Orange" Command="{Binding ChangeColorCommand}" CommandParameter="#FFFFCC99"/>
              <MenuItem Header="Pink" Command="{Binding ChangeColorCommand}" CommandParameter="#FFFF99FF"/>
              <MenuItem Header="Gray" Command="{Binding ChangeColorCommand}" CommandParameter="#FFCCCCCC"/>
            </MenuFlyout>
          </DropDownButton.Flyout>
        </DropDownButton>
      </Grid>
    </Border>

    <!-- Separator -->
    <Border Grid.Row="1" 
            Height="2" 
            Background="#66000000" 
            Margin="20,5,20,10"/>

    <!-- Items List -->
    <ScrollViewer Grid.Row="2" Margin="15,0,15,10">
      <ItemsControl ItemsSource="{Binding Note.Items}" x:CompileBindings="False">
        <ItemsControl.ItemTemplate>
          <DataTemplate>
            <Grid x:Name="ItemRow" ColumnDefinitions="Auto,Auto,*,Auto" ColumnSpacing="6" Margin="6,5,0,5"
                  Background="{Binding IsImportant, Converter={StaticResource ImportantRowBrush}}">
              <!-- Important Button -->
              <Button x:Name="ImportantButton"
                      Grid.Column="0"
                      Width="26"
                      Content="&#x1F6A8;"
                      FontFamily="Segoe UI Emoji, Segoe UI Symbol, Segoe UI"
                      HorizontalAlignment="Left"
                      Background="Transparent"
                      BorderThickness="0"
                      FontSize="18"
                      Padding="4"
                      Margin="2,0,8,0"
                      Foreground="{Binding IsImportant, Converter={StaticResource ImportantButtonBrush}}"
                      IsVisible="True"
                      Click="OnImportantButtonClick">
                <Button.Opacity>
                  <MultiBinding Converter="{StaticResource BoolOrConverter}">
                    <Binding Path="IsImportant" />
                    <Binding Path="#ItemRow.IsPointerOver" />
                  </MultiBinding>
                </Button.Opacity>
                <Button.IsHitTestVisible>
                  <MultiBinding Converter="{StaticResource BoolOrConverter}">
                    <Binding Path="IsImportant" />
                    <Binding Path="#ItemRow.IsPointerOver" />
                  </MultiBinding>
                </Button.IsHitTestVisible>
              </Button>

              <!-- Checkbox -->
              <CheckBox Grid.Column="1" 
                        IsChecked="{Binding IsCompleted}"
                        VerticalAlignment="Center"
                        Margin="6,0,10,0"/>
              
              <!-- Item Text with conditional styling -->
              <StackPanel Grid.Column="2" Orientation="Horizontal">
                <!-- Show non-strikethrough text when not completed -->
                <TextBlock Text="{Binding Text}"
                           FontSize="14"
                           TextWrapping="Wrap"
                           VerticalAlignment="Center"
                           IsVisible="{Binding !IsCompleted}"
                           Foreground="{Binding IsImportant, Converter={StaticResource ImportantBrush}}"
                           FontWeight="{Binding IsImportant, Converter={StaticResource ImportantFontWeight}}"/>
                
                <!-- Show strikethrough text when completed -->
                <TextBlock Text="{Binding Text}"
                           FontSize="14"
                           TextWrapping="Wrap"
                           TextDecorations="Strikethrough"
                           Foreground="{Binding IsImportant, Converter={StaticResource ImportantCompletedBrush}}"
                           VerticalAlignment="Center"
                           IsVisible="{Binding IsCompleted}"
                           FontWeight="{Binding IsImportant, Converter={StaticResource ImportantFontWeight}}"/>
              </StackPanel>

              <!-- Delete Button -->
              <Button Grid.Column="3"
                      Width="20"
                      Content="X"
                      Command="{Binding $parent[ItemsControl].DataContext.RemoveItemCommand}"
                      CommandParameter="{Binding}"
                      Background="Transparent"
                      BorderThickness="0"
                      FontSize="12"
                      Padding="5"
                      Margin="5,0,20,0"
                      Foreground="#D32F2F">
                <Button.Opacity>
                  <MultiBinding Converter="{StaticResource BoolOrConverter}">
                    <Binding Path="#ItemRow.IsPointerOver" />
                  </MultiBinding>
                </Button.Opacity>
                <Button.IsHitTestVisible>
                  <MultiBinding Converter="{StaticResource BoolOrConverter}">
                    <Binding Path="#ItemRow.IsPointerOver" />
                  </MultiBinding>
                </Button.IsHitTestVisible>
              </Button>
            </Grid>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </ScrollViewer>

    <!-- Input Area -->
    <Border Grid.Row="3" 
            Background="#33000000" 
            Padding="15"
            CornerRadius="0,0,5,5"
            Margin="10,5,10,10">
      <Grid ColumnDefinitions="*,Auto">
        <TextBox Grid.Column="0"
                 Text="{Binding NewItemText}"
                 Watermark="Add new item..."
                 Background="White"
                 BorderBrush="#FFAAAAAA"
                 BorderThickness="1"
                 Padding="8"
                 CornerRadius="3"
                 KeyDown="OnTextBoxKeyDown"/>
        
        <Button Grid.Column="1"
                Content="+"
                Command="{Binding AddItemCommand}"
                Background="#FF4CAF50"
                Foreground="White"
                Padding="10,8"
                Margin="10,0,0,0"
                CornerRadius="3"
                FontSize="16"/>
      </Grid>
    </Border>
  </Grid>
</Window>
